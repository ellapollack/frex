<!DOCTYPE html>
<html>

<head>
 <meta charset="UTF-8">
 <title>FREX</title>
 <script src="tone.js"></script>
 <script src="scalemap.js"></script>
 <script src="jsoncrush.js"></script>
 <style>

   body {
     background-color: black;
     background-image:url('stars.png');
     background-attachment: fixed;
     background-repeat: repeat;
     text-align: center;
     font-family: monospace;
     font-size: 16px;
     color: #ffffff88;
   }

   .vert {
     display:flex;
     justify-content: center;
     align-items:center;
   }

    .horiz {
      margin-left: 2em;
      margin-right: 2em;
    }

   #title>a {
     font-size: 2em;
     margin: 0.5em 1.5em 0.5em 1.5em;
     text-decoration: none;
   }

   #inputsContainer {
     display: flex;
     justify-content: center;
   }

   [contenteditable="plaintext-only"] {
     margin: 0 0 1em 0;
     background: #00ff000f;
     font-family: monospace;
     padding: 0.5em;
     color: #0f0;
     border: 1px solid white;
     text-align: left;
   }
 </style>
</head>

<body>
  <!--
  ██████   ██████  ██████  ██    ██
  ██   ██ ██    ██ ██   ██  ██  ██
  ██████  ██    ██ ██   ██   ████
  ██   ██ ██    ██ ██   ██    ██
  ██████   ██████  ██████     ██
  -->

<div id="title" class="vert">
  <a href="index.html" style="color:blue;">&#8635;</a>
  <a onclick="window.location=getLink(); return false;" href="#" style="color:yellow;">&uarr;</a>
  <a href="https://github.com/sponsors/maxwellpollack" style="color:red;">&#10084;</a>
</div>
<div class="vert">
  <pre id="text" style="color:#0f0;" contenteditable="plaintext-only" spellcheck='false'>   RESET        SAVE       SUPPORT

  ███████╗██████╗ ███████╗██╗  ██╗
  ██╔════╝██╔══██╗██╔════╝╚██╗██╔╝
  █████╗  ██████╔╝█████╗   ╚███╔╝
  ██╔══╝  ██╔══██╗██╔══╝   ██╔██╗
  ██║     ██║  ██║███████╗██╔╝ ██╗
  ╚═╝     ╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝
           EQUENCY          PLORER

 a keyboard-controlled synthesizer
   with precise tuning and timbre

   github.com/maxwellpollack/frex
____________________________________

    KEY MAP : the key(s) that play
              each note number.

       RATE : the number of steps
              per second.

   SEQUENCE : the key(s) to play
              at each step.

  ROOT NOTE : the note number of
              SCALE degree 0.

  ROOT FREQ : the frequency of
              ROOT NOTE, in Hz.

      SCALE : the interval of each
              SCALE degree, ending
              in the octave.

   PARTIALS : the amplitude of each
              harmonic in the
              oscillator waveform.

</pre>
</div>
<div id="inputsContainer">
  <div class="horiz">
    <pre class="label">KEY MAP</pre>
    <pre id="keymap" class="numbered" spellcheck="false" contenteditable="plaintext-only">`
z
a
q
1
x
s
w
2
c
d
e
3
v
f
r
4
b
g
t
5
n
h
y
6
m
j
u
7
,
k
i
8
.
l
o
9
/
;
p
0

'
[
-


]
=


\</pre>
  </div>
  <div class="horiz">
    <pre class="label">RATE</pre>
    <div class="vert">
      <pre id="rate" class="single-line" spellcheck="false" contenteditable="plaintext-only">5</pre>
    </div>
    <pre class="label">SEQUENCE</pre>
    <pre id="sequence" class="numbered" spellcheck="false" contenteditable="plaintext-only">zsdf
zerf
sdf5
sdfg
srt
xcyh
rft
dfry
456y
ghj
fyn
ry5
hj4
dbg5
xfgh
zfgy</pre>
  </div>
  <div class="horiz">
    <pre class="label">BASE NOTE</pre>
    <div class="vert"><pre id="baseNote" class="single-line" spellcheck="false" contenteditable="plaintext-only">2</pre></div>
    <pre class="label">BASE FREQ</pre>
    <div class="vert"><pre id="baseFreq" class="single-line" spellcheck="false" contenteditable="plaintext-only">100</pre></div>
    <pre class="label">SCALE</pre>
    <pre id="scale" class="numbered" spellcheck="false" contenteditable="plaintext-only">4/3
(4/3)^2
(4/3)^3
3/2</pre>
  </div>
  <div class="horiz">
    <pre class="label">PARTIALS</pre>
    <pre id="partials" class="numbered" spellcheck="false" contenteditable="plaintext-only">1
1/2
1/3</pre>
</div>
</div>

<!--
███████  ██████ ██████  ██ ██████  ████████
██      ██      ██   ██ ██ ██   ██    ██
███████ ██      ██████  ██ ██████     ██
     ██ ██      ██   ██ ██ ██         ██
███████  ██████ ██   ██ ██ ██         ██
-->
<script>

  Tone.context.latencyHint = "fastest";
  Tone.Transport.PPQ = 1;
  Tone.Transport.loopEnd = "4n";
  Tone.Transport.loop = true;

 var tuning = null;
 var keys = {};
 var pressedKeys = new Set();
 var playing = new Set();
 var partials = [1];
 var voices = [];
 var sequence = [];
 var step=0;
 var inc=1;
 var whiteNumber = null;

 document.getElementById('keymap').oninput = changedKeymap;
 document.getElementById('partials').oninput = changedPartials;
 document.getElementById('scale').oninput = changedTuningString;
 document.getElementById('baseNote').oninput = changedTuningString;
 document.getElementById('baseFreq').oninput = changedTuningString;
 document.getElementById('sequence').oninput = changedSequence;
 document.getElementById('rate').oninput = changedRate;

 let sl = document.getElementsByClassName('single-line');
 for (el of sl) {
   el.addEventListener('keydown', (e) => {
    if (e.keyCode == 13) {e.preventDefault();}
   });
   el.addEventListener('paste', (e) => {
    let paste = (e.clipboardData || window.clipboardData).getData('text');
    document.execCommand("insertText", false, paste.replace(/[\r?\n]+/g,""));
    e.preventDefault();
  });
 }

  function htmlToString(html) {
    return html.replace("<br>","\n").replace(/\n$/,"");
  }

  function stepSequence(time) {

    step = (step+inc+sequence.length) % sequence.length;

    for (key of playing) {
      if (!(pressedKeys.has(key) || sequence[step].includes(key))) {
        voices[keys[key]-1].triggerRelease(time);
        playing.delete(key);
      }
    }

    for (let i=0; i<sequence[step].length; i++) {
      let key = sequence[step][i];
      if (key in keys && !playing.has(key)) {
        playing.add(key);
        let freq = Module.ccall('noteToFreq', 'number', ['number', 'number'], [keys[key], tuning]);
        voices[keys[key]-1].oscillator.partials = partials;
        voices[keys[key]-1].triggerAttack(freq, time, Math.min(0.5,10/freq));
      }
    }

    Tone.Draw.schedule(function(){
      whiteNumber.style.color = "";
      whiteNumber = document.querySelector('#sequence').parentNode.firstChild.childNodes[step];
      whiteNumber.style.color = "white";
	  }, time);
  }

 window.addEventListener('keydown', this.onkeydown);
 window.addEventListener('keyup', this.onkeyup);

 function onkeydown(e) {
  if (!(e.repeat || e.shiftKey || e.ctrlKey || e.metaKey)) {
    pressedKeys.add(e.key);
    if (e.key in keys && !playing.has(e.key)) {
      playing.add(e.key);
      let freq = Module.ccall('noteToFreq', 'number', ['number', 'number'], [keys[e.key], tuning]);
      voices[keys[e.key]-1].oscillator.partials = partials;
      voices[keys[e.key]-1].triggerAttack(freq, "+0", Math.min(0.5,10/freq));
    }
  }
 }

 function onkeyup(e) {
   if (!(e.repeat || e.shiftKey || e.ctrlKey || e.metaKey)) {
     pressedKeys.delete(e.key);
     if (e.key in keys && !sequence[step].includes(e.key)) {
       playing.delete(e.key);
       voices[keys[e.key]-1].triggerRelease();
     }
   }
 }

 function changedRate() {
   let expr = document.getElementById('rate').innerHTML;
   let val = Module.ccall('te_interp', 'number', ['string','number'], [expr, 0]);
   if (!isNaN(val)) {
     if (val==0) {
       Tone.Transport.stop();
       for (key of playing) {
         playing.delete(key);
         voices[keys[key]-1].triggerRelease();
       }
     } else {
       Tone.Transport.bpm.value = Math.abs(val)*60;
       inc = val>0 ? 1 : -1;
       Tone.Transport.start();
    }
  }
 }

 function changedSequence() {
   let elm = document.getElementById('sequence');
   sequence = htmlToString(elm.innerHTML).split(/\r?\n/);
   updateNumbers(elm);
 }

function changedKeymap() {
  let elm = document.getElementById('keymap');
  let lines = htmlToString(keymap.innerHTML).split(/\r?\n/);

  keys = {};

  for (let i=0; i<lines.length; i++) {
    for (let j=0; j<lines[i].length; j++)
    {
      keys[lines[i][j]] = i+1;
    }
  }

  let i=voices.length;
  if (lines.length>voices.length) {
    while (i<lines.length) {
      voices.push(new Tone.Synth({
        oscillator : {partials : partials} ,
        envelope : {attack : 0.01 , decay : 10 , sustain : 1 , release : 0.01}
      }).toMaster());
      i++;
    }
  } else {
    while (i>lines.length) {
      i--;
      voices[i].dispose();
      voices.pop();
    }
  }

  updateNumbers(elm);
}

function changedTuningString() {

  let elm = document.getElementById("scale");
  let scale = htmlToString(elm.innerHTML);
  let baseNote = document.getElementById("baseNote").innerHTML;
  let baseFreq = document.getElementById("baseFreq").innerHTML;

  let tmp = Module.ccall('tuningFromString', 'number', ['string'], [baseNote + ":" + baseFreq + "\n" + scale]);
  if (tmp != 0) {
    Module.ccall('free', 'void', ['number'], [tuning]);
    tuning = tmp;
  }

  updateNumbers(elm);
}

function changedPartials() {

  let elm = document.getElementById("partials");
  let lines = htmlToString(elm.innerHTML).split(/\r?\n/);

  let arr = lines.map(
    (numstr) => Module.ccall('te_interp', 'number', ['string','number'], [numstr, 0])
  );

  let i=0;
  if (arr.length>partials.length) {
    while (i<partials.length) {
      partials[i] = isNaN(arr[i]) ? 0 : arr[i];
      i++;
    }
    while (i<arr.length) {
      partials.push(isNaN(arr[i]) ? 0 : arr[i]);
      i++;
    }
  } else {
    while (i<arr.length) {
      partials[i] = isNaN(arr[i]) ? 0 : arr[i];
      i++;
    }
    while (partials.length>arr.length) {
      partials.pop();
    }
  }

  updateNumbers(elm);
}

window.onbeforeunload = () => {
   Module.ccall('free', 'void', ['number'], [tuning]);
   return null;
}

Module.onRuntimeInitialized = () => {
  let numbered = document.getElementsByClassName("numbered");
  for (let i=0; i< numbered.length; i++) {
    initNumbers(numbered[i]);
  }

  let p = new URLSearchParams(document.location.search.substring(1));
  p = p.get('p');
  if (p!=null) {
    let params = JSON.parse(JSONUncrush(p));

    document.getElementById("text").innerHTML = params.t;
    document.getElementById("partials").innerHTML = params.p;
    document.getElementById("scale").innerHTML = params.s;
    document.getElementById("baseNote").innerHTML = params.n;
    document.getElementById("baseFreq").innerHTML = params.f;
    document.getElementById("keymap").innerHTML = params.k;
    document.getElementById("rate").innerHTML = params.r;
    document.getElementById("sequence").innerHTML = params.q;
  }
  changedTuningString();
  changedKeymap();
  changedPartials();
  changedSequence();
  changedRate();

  whiteNumber = document.querySelector('#sequence').parentNode.firstChild.childNodes[step];

  Tone.Transport.scheduleRepeat(stepSequence, "4n");
}

function getLink() {
  return '?p=' + JSONCrush(JSON.stringify(
    {'t': document.getElementById('text').innerHTML,
     'k': document.getElementById('keymap').innerHTML,
     'n': document.getElementById('baseNote').innerHTML,
     'f': document.getElementById('baseFreq').innerHTML,
     's': document.getElementById('scale').innerHTML,
     'p': document.getElementById('partials').innerHTML,
     'r': document.getElementById('rate').innerHTML,
     'q': document.getElementById('sequence').innerHTML}
  ));
}

function initNumbers(numbered) {
  let container = document.createElement("div");
  let numbers = document.createElement("pre");
  numbered.parentNode.insertBefore(container, numbered);
  container.appendChild(numbers);
  container.appendChild(numbered);
  container.style.position = "relative";
  container.style.display = "inline-block";
  numbers.style.position = "absolute";
  numbers.style.textAlign = "right";
  numbers.style.top = "0";

  let style = window.getComputedStyle(numbered);
  numbers.style.padding = style.getPropertyValue('padding');
  numbers.style.margin = style.getPropertyValue('margin');
  numbers.style.fontSize = style.getPropertyValue('font-size');
}

function updateNumbers(numbered) {
  let numbers = numbered.parentNode.firstChild;

  numbers.innerHTML = '<div class="l1">1</div>';
  let line = 2;
  while (numbers.clientHeight < numbered.clientHeight)
  {
    numbers.insertAdjacentHTML("beforeend", '<div class="l'+line+'">'+line+"</div>");
    line++;
  }

  numbers.style.left = (-numbers.scrollWidth).toString()+"px";
}

</script>

</body>

</html>
